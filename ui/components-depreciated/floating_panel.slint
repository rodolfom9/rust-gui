import { ListView, VerticalBox, StandardListView, ScrollView } from "std-widgets.slint";

// Botão da toolbar de camadas
component LayerToolButton inherits Rectangle {
    in property <image> icon;
    in property <string> tooltip;
    
    width: 32px;
    height: 32px;
    border-radius: 3px;
    
    states [
        hover when touch-area.has-hover: {
            background: #d5dbdb;
        }
        pressed when touch-area.pressed: {
            background: #bdc3c7;
        }
    ]
    
    touch-area := TouchArea { }
    
    Image {
        source: root.icon;
        width: 20px;
        height: 20px;
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
    }
}

// Item de camada
component LayerItem inherits Rectangle {
    in property <string> layer-name;
    in property <int> layer-index;
    
    height: 32px;
    border-radius: 4px;
    
    states [
        hover when touch-area.has-hover: {
            background: #e8f4f8;
        }
        selected when touch-area.pressed: {
            background: #d0e8f0;
        }
    ]
    
    touch-area := TouchArea { }
    
    HorizontalLayout {
        padding-left: 8px;
        padding-right: 8px;
        spacing: 8px;
        
        Image {
            source: @image-url("../../images/themes/default/mIconPolygonLayer.svg");
            width: 16px;
            height: 16px;
        }
        
        Text {
            text: root.layer-name;
            color: #2c3e50;
            font-size: 13px;
            vertical-alignment: center;
            horizontal-stretch: 1;
        }
        
        Image {
            source: @image-url("../../images/themes/default/mActionShowAllLayers.svg");
            width: 14px;
            height: 14px;
        }
    }
}

// Painel flutuante e movimentável para camadas
export component FloatingLayersPanel inherits Rectangle {
    in property <[string]> layers: ["Camada 1", "Camada 2", "Camada 3"];
    property <bool> is-collapsed: false;
    property <bool> is-visible: true;
    
    // Propriedades para arrastar
    property <length> drag-offset-x: 0px;
    property <length> drag-offset-y: 0px;
    property <bool> is-snapped-left: target-x-clamped < snap-distance;
    property <bool> is-snapped-right: target-x-clamped > max-x - snap-distance;
    
    // Dimensões da área de trabalho (área utilizável da janela principal)
    property <length> workspace-x: 0px;
    property <length> workspace-y: 80px; // Após MenuBar (40px) e Toolbar
    property <length> workspace-width: 1400px; // Será ajustado dinamicamente
    property <length> workspace-height: 800px; // Será ajustado dinamicamente
    
    // Zona magnética (distância para snap)
    property <length> snap-distance: 30px;
    
    // Largura do painel
    property <length> panel-width: is-collapsed ? 50px : 280px;
    
    // Calcular posição X com limites
    property <length> target-x-raw: 20px + drag-offset-x;
    property <length> max-x: workspace-width - panel-width - 20px;
    property <length> target-x-clamped: Math.max(workspace-x, Math.min(target-x-raw, max-x));
    
    // Calcular posição Y com limites
    property <length> target-y-raw: workspace-y + drag-offset-y;
    property <length> max-y: workspace-height - self.height;
    property <length> calculated-y: Math.max(workspace-y, Math.min(target-y-raw, max-y));
    
    // Aplicar snap magnético
    property <length> calculated-x: {
        // Snap esquerda
        if (target-x-clamped < snap-distance) {
            workspace-x + 10px
        } 
        // Snap direita
        else if (target-x-clamped > max-x - snap-distance) {
            max-x - 10px
        }
        // Posição livre
        else {
            target-x-clamped
        }
    };
    
    visible: is-visible;
    x: calculated-x;
    y: calculated-y;
    width: is-collapsed ? 50px : 280px;
    height: 400px;
    background: is-snapped-left || is-snapped-right ? #f0f3f4 : #f8f9fa;
    border-radius: 6px;
    drop-shadow-blur: 8px;
    drop-shadow-color: #00000040;
    
    animate width { duration: 250ms; easing: ease-in-out; }
    animate x { duration: 150ms; easing: ease-out; }
    animate background { duration: 200ms; }
    
    // Indicador de snap (barra lateral)
    if root.is-snapped-left: Rectangle {
        x: 0px;
        width: 3px;
        height: parent.height;
        background: #3498db;
        border-top-left-radius: 6px;
        border-bottom-left-radius: 6px;
    }
    
    if root.is-snapped-right: Rectangle {
        x: parent.width - 3px;
        width: 3px;
        height: parent.height;
        background: #3498db;
        border-top-right-radius: 6px;
        border-bottom-right-radius: 6px;
    }
    
    VerticalLayout {
        padding: 0px;
        spacing: 0px;
        
        // Cabeçalho arrastável
        header := Rectangle {
            height: 40px;
            background: #34495e;
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
            
            // Área de arrastar
            drag-area := TouchArea {
                width: parent.width - 80px;
                height: parent.height;
                
                moved => {
                    if (self.pressed) {
                        root.drag-offset-x += self.mouse-x - self.pressed-x;
                        root.drag-offset-y += self.mouse-y - self.pressed-y;
                    }
                }
            }
            
            HorizontalLayout {
                padding: 8px;
                spacing: 8px;
                
                // Ícone de camadas
                Image {
                    source: @image-url("../../images/themes/default/mActionLayers.svg");
                    width: 20px;
                    height: 20px;
                }
                
                // Título
                if (!root.is-collapsed) : Text {
                    text: "Camadas";
                    color: #ffffff;
                    font-size: 14px;
                    font-weight: 600;
                    vertical-alignment: center;
                    horizontal-stretch: 1;
                }
                
                Rectangle {
                    horizontal-stretch: 1;
                }
                
                // Botão minimizar/expandir
                minimize-btn := Rectangle {
                    width: 28px;
                    height: 28px;
                    border-radius: 4px;
                    
                    states [
                        hover when minimize-touch.has-hover: {
                            background: #2c3e50;
                        }
                    ]
                    
                    minimize-touch := TouchArea {
                        clicked => {
                            root.is-collapsed = !root.is-collapsed;
                        }
                    }
                    
                    Text {
                        text: root.is-collapsed ? "+" : "−";
                        color: #ffffff;
                        font-size: 18px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
                
                // Botão fechar
                close-btn := Rectangle {
                    width: 28px;
                    height: 28px;
                    border-radius: 4px;
                    
                    states [
                        hover when close-touch.has-hover: {
                            background: #e74c3c;
                        }
                    ]
                    
                    close-touch := TouchArea {
                        clicked => {
                            root.is-visible = false;
                        }
                    }
                    
                    Text {
                        text: "✕";
                        color: #ffffff;
                        font-size: 16px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
            }
        }
        
        // Toolbar de camadas
        if (!root.is-collapsed) : Rectangle {
            height: 40px;
            background: #ecf0f1;
            
            HorizontalLayout {
                padding: 4px;
                spacing: 2px;
                
                LayerToolButton {
                    icon: @image-url("../../images/themes/default/mActionAdd.svg");
                    tooltip: "Adicionar Camada";
                }
                
                LayerToolButton {
                    icon: @image-url("../../images/themes/default/mActionRemove.svg");
                    tooltip: "Remover Camada";
                }
                
                LayerToolButton {
                    icon: @image-url("../../images/themes/default/mActionToggleEditing.svg");
                    tooltip: "Editar Camada";
                }
            }
            
            // Linha divisória
            Rectangle {
                y: parent.height - self.height;
                height: 1px;
                background: #d0d0d0;
            }
        }
        
        // Lista de camadas
        layers-list := Rectangle {
            background: #ffffff;
            vertical-stretch: 1;
            border-radius: 6px;
            
            if (!root.is-collapsed) : ScrollView {
                VerticalLayout {
                    padding: 8px;
                    spacing: 4px;
                    
                    for layer[index] in root.layers: LayerItem {
                        layer-name: layer;
                        layer-index: index;
                    }
                }
            }
            
            if (root.is-collapsed) : VerticalLayout {
                padding: 8px;
                spacing: 4px;
                
                for layer[index] in root.layers: TouchArea {
                    height: 32px;
                    
                    Image {
                        source: @image-url("../../images/themes/default/mIconPolygonLayer.svg");
                        width: 24px;
                        height: 24px;
                        x: (parent.width - self.width) / 2;
                        y: (parent.height - self.height) / 2;
                    }
                }
            }
        }
    }
}
